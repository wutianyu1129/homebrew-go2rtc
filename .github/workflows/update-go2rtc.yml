name: Update go2rtc formula

on:
  schedule:
    - cron: "0 6 * * *"   # 每天 06:00 UTC 跑一次
  workflow_dispatch:       # 允许手动触发

jobs:
  update-formula:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout tap repo
        uses: actions/checkout@v4

      - name: Get latest go2rtc release tag
        id: latest
        run: |
          api="https://api.github.com/repos/AlexxIT/go2rtc/releases/latest"
          json=$(curl -s "$api")
          tag=$(echo "$json" | jq -r '.tag_name')
          version="${tag#v}"
          echo "Latest tag: $tag"
          echo "Latest version: $version"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Get current version from formula (if exists)
        id: current
        run: |
          if [ -f Formula/go2rtc.rb ]; then
            current=$(grep 'version "' Formula/go2rtc.rb | head -n1 | sed -E 's/.*"([^"]+)".*/\1/')
          else
            current=""
          fi
          echo "Current version: $current"
          echo "current=$current" >> "$GITHUB_OUTPUT"

      - name: Already up to date?
        if: steps.latest.outputs.version == steps.current.outputs.current
        run: |
          echo "Already up to date: ${{ steps.current.outputs.current }}"

      - name: Download new binaries and calculate sha256
        if: steps.latest.outputs.version != steps.current.outputs.current
        id: sha
        run: |
          tag="${{ steps.latest.outputs.tag }}"

          arm_url="https://github.com/AlexxIT/go2rtc/releases/download/${tag}/go2rtc_mac_arm64.zip"
          amd_url="https://github.com/AlexxIT/go2rtc/releases/download/${tag}/go2rtc_mac_amd64.zip"

          echo "Downloading $arm_url"
          curl -L "$arm_url" -o go2rtc_mac_arm64.zip

          echo "Downloading $amd_url"
          curl -L "$amd_url" -o go2rtc_mac_amd64.zip

          arm_sha=$(shasum -a 256 go2rtc_mac_arm64.zip | cut -d' ' -f1)
          amd_sha=$(shasum -a 256 go2rtc_mac_amd64.zip | cut -d' ' -f1)

          echo "arm_sha=$arm_sha"
          echo "amd_sha=$amd_sha"

          echo "arm_url=$arm_url" >> "$GITHUB_OUTPUT"
          echo "amd_url=$amd_url" >> "$GITHUB_OUTPUT"
          echo "arm_sha=$arm_sha" >> "$GITHUB_OUTPUT"
          echo "amd_sha=$amd_sha" >> "$GITHUB_OUTPUT"

      - name: Rewrite Formula/go2rtc.rb
        if: steps.latest.outputs.version != steps.current.outputs.current
        run: |
          version="${{ steps.latest.outputs.version }}"
          arm_url="${{ steps.sha.outputs.arm_url }}"
          amd_url="${{ steps.sha.outputs.amd_url }}"
          arm_sha="${{ steps.sha.outputs.arm_sha }}"
          amd_sha="${{ steps.sha.outputs.amd_sha }}"

          mkdir -p Formula

          # 这里直接把变量插进去，不再用占位符 + sed
          cat > Formula/go2rtc.rb <<EOF
          class Go2rtc < Formula
            desc "Ultimate camera streaming application with RTSP, WebRTC, RTMP, etc."
            homepage "https://github.com/AlexxIT/go2rtc"
            version "${version}"

            # 只处理 macOS（arm64 / amd64），URL 和 SHA 由 workflow 自动填入
            if Hardware::CPU.arm?
              url "${arm_url}"
              sha256 "${arm_sha}"
            else
              url "${amd_url}"
              sha256 "${amd_sha}"
            end

            def install
              # 上游 zip 解压后里面的二进制名是 go2rtc_mac_arm64 / go2rtc_mac_amd64
              bin_name = if Hardware::CPU.arm?
                "go2rtc_mac_arm64"
              else
                "go2rtc_mac_amd64"
              end

              bin.install bin_name => "go2rtc"

              # 默认配置目录：/opt/homebrew/etc/go2rtc/go2rtc.yaml
              (etc/"go2rtc").mkpath
              config_file = etc/"go2rtc/go2rtc.yaml"
              unless config_file.exist?
                config_file.write <<~YAML
                  # go2rtc default config
                  # 修改这个文件后重启服务生效：brew services restart go2rtc
                  streams: {}
                YAML
              end
            end

            def post_install
              # 工作目录和日志目录
              (var/"go2rtc").mkpath
              (var/"log").mkpath
            end

            def caveats
              <<~EOS
                配置文件:
                  \#{etc}/go2rtc/go2rtc.yaml

                日志文件:
                  \#{var}/log/go2rtc.log

                作为守护进程运行、开机自启:
                  brew services start \#{name.downcase}

                停止守护进程:
                  brew services stop \#{name.downcase}

                修改配置后重启:
                  brew services restart \#{name.downcase}
              EOS
            end

            # Homebrew 守护进程配置 => 转成 launchd plist
            service do
              run [opt_bin/"go2rtc", "-config", etc/"go2rtc/go2rtc.yaml"]
              working_dir var/"go2rtc"

              # 崩溃/退出自动重启 & 开机自启
              keep_alive true

              # 日志
              log_path var/"log/go2rtc.log"
              error_log_path var/"log/go2rtc.log"
            end

            test do
              output = shell_output("\#{bin}/go2rtc -h 2>&1")
              assert_match "go2rtc", output
            end
          end
          EOF

          echo "New Formula/go2rtc.rb:"
          cat Formula/go2rtc.rb

      - name: Commit and push changes
        if: steps.latest.outputs.version != steps.current.outputs.current
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: bump go2rtc to ${{ steps.latest.outputs.tag }}"
          branch: main
